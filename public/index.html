<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catálogo - IgorValen Distribuidora</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand-green: #0f8a3a;
      --brand-green-darker: #0b5d29;
      --brand-red: #de1f36;
      --text: #111111;
      --bg-soft: #f3f4f6;
    }
    html, body { min-height:100%; font-family:'Poppins', sans-serif; scroll-behavior: smooth; }
    body { background-color: var(--brand-red); position:relative; overflow-x:hidden; }
    body::before {
      content:''; position:absolute; top:0; left:0; right:0;
      height:50vh; min-height:400px; background:var(--brand-green);
      clip-path: ellipse(100% 100% at 50% 0%); z-index:0;
    }
    body::after {
      content:''; position:fixed; inset:0;
      background-image: url('data:image/svg+xml;utf8,<svg width="100" height="20" viewBox="0 0 100" xmlns="http://www.w3.org/2000/svg"><path d="M0 10 C 25 0, 75 20, 100 10" stroke="%23000000" stroke-width="0.5" fill="none" opacity="0.06"/></svg>');
      background-size:100px 20px; pointer-events:none; z-index:1;
    }
    #root { position:relative; z-index:2; padding-bottom:200px; }
    .panel { background:white; border-radius:1.5rem; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    .category-wave-wrapper { position:relative; padding:2rem 1.5rem; border-radius:1.5rem; overflow:hidden; background-color:var(--brand-green); }
    .category-wave-wrapper::before,.category-wave-wrapper::after{
      content:''; position:absolute; left:-50%; width:200%; height:100%; background:var(--brand-green-darker); border-radius:50%; opacity:0.3; z-index:0;
    }
    .category-wave-wrapper::before{ top:10%; transform:rotate(4deg); }
    .category-wave-wrapper::after{ bottom:10%; transform:rotate(-4deg); }
    .category-content{ position:relative; z-index:1; }
    .toggle { width:52px; height:28px; background:#e5e7eb; border-radius:9999px; position:relative; transition:background .2s; cursor:pointer; }
    .toggle.active { background:#16a34a; }
    .knob { width:24px; height:24px; background:white; border-radius:9999px; position:absolute; top:2px; left:2px; transition:left .2s; }
    .toggle.active .knob { left:26px; }
    .banner img {
      width: 100%;
      height: 500px;
      max-height: none;
      object-fit: cover;
      background: #0f8a3a;
    }
    .iso-round { width:140px; height:140px; border-radius:9999px; background:#fff; display:flex; align-items:center; justify-content:center; margin:0 auto 12px; }
    .iso-round img{ width:80%; height:80%; object-fit:contain; }
    @media (min-width: 640px) {
      .ism-section { flex-direction: row !important; align-items: stretch !important; }
      .ism-section .ism-image { width:50%; display:grid; grid-template-rows:1fr 1fr; grid-template-columns:1fr; height:100%; }
      .ism-section .ism-image img { width:100%; height:100%; object-fit:cover; }
      .ism-section .ism-text { width:50%; max-width:none; }
    }
    </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, createContext, useContext } = React;
    const AppContext = createContext();

    const categoryIcons = {
      'Todas': (
        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 8.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25A2.25 2.25 0 0 1 13.5 8.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z"/></svg>
      ),
      'Bomboniere': (
        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 7v10.9"/><path d="M14 6.1V17"/><path d="M16 7V3a1 1 0 0 1 1.707-.707 2.5 2.5 0 0 0 2.152.717 1 1 0 0 1 1.131 1.131 2.5 2.5 0 0 0 .717 2.152A1 1 0 0 1 21 8h-4"/><path d="M16.536 7.465a5 5 0 0 0-7.072 0l-2 2a5 5 0 0 0 0 7.07 5 5 0 0 0 7.072 0l2-2a5 5 0 0 0 0-7.07"/><path d="M8 17v4a1 1 0 0 1-1.707.707 2.5 2.5 0 0 0-2.152-.717 1 1 0 0 1-1.131-1.131 2.5 2.5 0 0 0-.717-2.152A1 1 0 0 1 3 16h4"/></svg>
      ),
      'Bebidas não alcoólicas': (
        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 8 1.75 12.28a2 2 0 0 0 2 1.72h4.54a2 2 0 0 0 2-1.72L18 8"/><path d="M5 8h14"/><path d="M7 15a6.47 6.47 0 0 1 5 0 6.47 6.47 0 0 0 5 0"/><path d="m12 8 1-6h2"/></svg>
      ),
      'Bebidas alcoólicas': (
        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M9 12v6"/><path d="M13 12v6"/><path d="M14 7.5c-1 0-1.44.5-3 .5s-2-.5-3-.5-1.72.5-2.5.5a2.5 2.5 0 0 1 0-5c.78 0 1.57.5 2.5.5S9.44 2 11 2s2 1.5 3 1.5 1.72-.5 2.5-.5a2.5 2.5 0 0 1 0 5c-.78 0-1.5-.5-2.5-.5Z"/><path d="M5 8v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8"/></svg>
      ),
      'Cigarro': (
        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 12H3a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h14"/><path d="M18 8c0-2.5-2-2.5-2-5"/><path d="M21 16a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M22 8c0-2.5-2-2.5-2-5"/><path d="M7 12v4"/></svg>
      ),
      'Utilidades': (
        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z"/></svg>
      ),
      default: (
        <svg className="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
      )
    };

    const getCategoryIcon = (cat) => categoryIcons[cat] || categoryIcons.default;

    const api = {
      loginAdmin: async (password)=>{
        const res = await fetch('/api/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({password}) })
        return res.json()
      },
      getCatalog: async (q)=>{
        const params = new URLSearchParams(q||{}).toString();
        const res = await fetch('/api/catalog'+(params?'?'+params:''))
        if (!res.ok) {
          const err = await res.json().catch(() => ({}))
          throw new Error(err.error || 'Erro ao carregar catálogo')
        }
        return res.json()
      },
      getAdminProducts: async ()=> (await fetch('/api/admin/products')).json(),
      getProduct: async (id)=> (await fetch('/api/products/'+id)).json(),
      createProduct: async (formData)=> (await fetch('/api/products',{method:'POST', body: formData})).json(),
      updateProduct: async (id, formData)=> (await fetch('/api/products/'+id,{ method:'PUT', body: formData })).json(),
      deleteProduct: async (id)=> (await fetch('/api/products/'+id,{ method:'DELETE' })).json(),
      reorderProducts: async (ids)=> (await fetch('/api/products/reorder',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(ids) })).json(),
    };

    async function exportCatalogImages(includePrices) {
      try {
        const data = await api.getCatalog();
        const activeProducts = (data.products || []).filter(p => p.active !== false);
        let categories = data.settings?.categoriesOrder || [];
        if (!categories.length) {
          categories = [...new Set(activeProducts.map(p => p.category))].sort();
        }
        const exportContainer = document.createElement('div');
        exportContainer.style.position = 'fixed';
        exportContainer.style.top = '-2000px';
        exportContainer.style.left = '0';
        exportContainer.style.width = '1080px';
        exportContainer.style.height = '1920px';
        exportContainer.style.backgroundColor = 'var(--brand-green)';
        document.body.appendChild(exportContainer);

        for (const category of categories) {
          const items = activeProducts.filter(p => p.category === category);
          if (!items.length) continue;
          const pageSize = 8;
          const pagesNeeded = Math.ceil(items.length / pageSize);
          for (let pageIndex = 0; pageIndex < pagesNeeded; pageIndex++) {
            const pageProducts = items.slice(pageIndex * pageSize, (pageIndex + 1) * pageSize);
            exportContainer.innerHTML = '';

            const logoImg = document.createElement('img');
            logoImg.src = '/logo.png';
            logoImg.alt = 'Logo';
            logoImg.style.maxHeight = '100px';
            logoImg.style.display = 'block';
            logoImg.style.margin = '20px auto 10px auto';
            logoImg.onerror = () => { logoImg.style.display = 'none'; };
            exportContainer.appendChild(logoImg);

            const title = document.createElement('h2');
            title.textContent = category;
            title.style.color = '#fff';
            title.style.textAlign = 'center';
            title.style.fontSize = '48px';
            title.style.fontWeight = '700';
            title.style.marginBottom = '20px';
            title.style.textShadow = '1px 1px 3px rgba(0,0,0,0.5)';
            exportContainer.appendChild(title);

            const panel = document.createElement('div');
            panel.style.margin = '0 20px';
            panel.style.background = 'white';
            panel.style.borderRadius = '30px';
            panel.style.padding = '20px';
            panel.style.boxSizing = 'border-box';
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = '1fr 1fr';
            grid.style.gap = '16px';
            panel.appendChild(grid);
            exportContainer.appendChild(panel);

            pageProducts.forEach(product => {
              const card = document.createElement('div');
              card.style.background = 'white';
              card.style.border = '1px solid #e5e7eb';
              card.style.borderRadius = '16px';
              card.style.padding = '10px';
              card.style.display = 'flex';
              card.style.flexDirection = 'column';
              const img = document.createElement('img');
              img.src = product.imageUrl || '/img/placeholder.png';
              img.alt = product.name;
              img.style.width = '100%';
              img.style.height = '180px';
              img.style.objectFit = 'contain';
              card.appendChild(img);
              const nameEl = document.createElement('h3');
              nameEl.textContent = product.name;
              nameEl.style.color = 'var(--brand-green)';
              nameEl.style.fontWeight = '700';
              nameEl.style.fontSize = '18px';
              nameEl.style.marginTop = '8px';
              card.appendChild(nameEl);
              const codesEl = document.createElement('p');
              codesEl.textContent = 'Códigos: ' + (product.codes || '-');
              codesEl.style.fontSize = '12px';
              codesEl.style.color = '#555';
              card.appendChild(codesEl);
              if (product.flavors) {
                const flavEl = document.createElement('p');
                flavEl.textContent = 'Sabores: ' + product.flavors;
                flavEl.style.fontSize = '12px';
                flavEl.style.color = '#555';
                card.appendChild(flavEl);
              }
              if (includePrices) {
                const priceCashUnit = product.priceUV != null ? `R$ ${Number(product.priceUV).toFixed(2)}` : null;
                const priceCashPack = product.priceFV != null ? `R$ ${Number(product.priceFV).toFixed(2)}` : null;
                const priceCredUnit = product.priceUP != null ? `R$ ${Number(product.priceUP).toFixed(2)}` : null;
                const priceCredPack = product.priceFP != null ? `R$ ${Number(product.priceFP).toFixed(2)}` : null;
                if (priceCashUnit || priceCashPack) {
                  const el = document.createElement('p');
                  el.textContent = 'À vista: ' + [priceCashUnit, priceCashPack].filter(Boolean).join(' / ');
                  el.style.fontSize = '13px';
                  el.style.fontWeight = '500';
                  card.appendChild(el);
                }
                if (priceCredUnit || priceCredPack) {
                  const el = document.createElement('p');
                  el.textContent = 'A prazo: ' + [priceCredUnit, priceCredPack].filter(Boolean).join(' / ');
                  el.style.fontSize = '13px';
                  el.style.fontWeight = '500';
                  card.appendChild(el);
                }
              }
              grid.appendChild(card);
            });

            const canvas = await html2canvas(exportContainer, { useCORS: true });
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            if (blob) {
              let fileName = category.replace(/[\/\\?%*:|"<>]/g, '_');
              if (pagesNeeded > 1) fileName += `_${pageIndex+1}`;
              fileName += '.png';
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = fileName;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }
          }
        }
        document.body.removeChild(exportContainer);
      } catch (err) {
        console.error('Erro ao gerar catálogo como imagens:', err);
        alert('Ocorreu um erro ao gerar as imagens do catálogo.');
      }
    }

    const ExportOptionsModal = ({ onClose, onSelectOption }) => (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-xl p-6 w-full max-w-xs">
          <h2 className="text-lg font-bold mb-4 text-gray-800 text-center">Exportar Catálogo</h2>
          <p className="text-sm text-gray-600 mb-6 text-center">Selecione uma opção:</p>
          <button onClick={() => onSelectOption(true)} className="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 mb-3">Exportar com preços</button>
          <button onClick={() => onSelectOption(false)} className="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 mb-3">Exportar sem preços</button>
          <button onClick={onClose} className="w-full bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg mt-2">Cancelar</button>
        </div>
      </div>
    );

    const AppProvider = ({children})=>{
      const [route, setRoute] = useState({name:'home', params:{}});
      const [isAdmin, setIsAdmin] = useState(false);
      const [offline, setOffline] = useState(()=> localStorage.getItem('offline') === 'true');
      const navigate = (name, params = {}) => {
        let path = name === 'home' ? '/' : `/${name}`;
        if (params && typeof params.id !== 'undefined' && params.id !== null) {
          path += `?id=${encodeURIComponent(params.id)}`;
        }
        history.pushState(params, '', path);
        setRoute({ name, params });
      };
      useEffect(()=>{
        const path = location.pathname.slice(1);
        setRoute({ name: path || 'home', params:{} });
        const onPop = (e)=>{
          const p = location.pathname.slice(1);
          setRoute({ name: p || 'home', params: e.state || {} });
        }
        addEventListener('popstate', onPop);
        return ()=> removeEventListener('popstate', onPop);
      },[]);
      const auth = {
        isAdmin,
        login: async (pwd)=>{
          const r = await api.loginAdmin(pwd);
          if (r.ok) setIsAdmin(true);
          return r;
        },
        logout: ()=> setIsAdmin(false),
      };

      useEffect(()=>{
        if ('serviceWorker' in navigator){
          navigator.serviceWorker.ready.then(reg=>{
            reg.active?.postMessage({type:'offline', enabled: offline});
          });
        }
        localStorage.setItem('offline', offline);
      }, [offline]);

      const toggleOffline = ()=> setOffline(v=>!v);

      return <AppContext.Provider value={{route, navigate, auth, offline, toggleOffline}}>{children}</AppContext.Provider>
    };
    const useApp = ()=> useContext(AppContext);

    const Header = ()=>{
      const { navigate, offline, toggleOffline } = useApp();
      const [showExportOptions, setShowExportOptions] = useState(false);
      return (
        <header className="sticky top-0 z-40 shadow-lg" style={{backgroundColor:'var(--brand-green)'}}>
          <div className="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-24">
            <div className="bg-white px-4 py-2 rounded-xl shadow cursor-pointer transform hover:scale-105 transition-transform" onClick={()=>navigate('home')}>
              <div className="flex items-baseline">
                <span className="text-3xl font-bold" style={{color:'var(--brand-green)'}}>Igor</span>
                <span className="text-3xl font-bold" style={{color:'var(--brand-red)'}}>Valen</span>
              </div>
              <span className="block text-sm -mt-1 font-medium text-gray-800 text-right">Distribuidora</span>
            </div>
            <div className="flex items-center space-x-4 text-white font-semibold">
              <button onClick={() => navigate('home')} className="hover:text-green-200 transition-colors">Catálogo</button>
              <div className="flex items-center gap-2">
                <span className="text-sm">Usar sem Wi-Fi</span>
                <div onClick={toggleOffline} className={`toggle ${offline?'active':''}`}><div className="knob"></div></div>
              </div>
              <button onClick={() => setShowExportOptions(true)} className="bg-blue-600 text-white font-semibold px-4 py-2 rounded-full shadow hover:bg-blue-700 transition-all transform hover:scale-105">Baixar catálogo</button>
              <button onClick={() => navigate('admin')} className="bg-white text-green-600 font-semibold px-4 py-2 rounded-full shadow hover:bg-gray-100 transition-all transform hover:scale-105">Área do&nbsp;Admin</button>
            </div>
          </div>
          {showExportOptions && (
            <ExportOptionsModal
              onClose={() => setShowExportOptions(false)}
              onSelectOption={(includePrices) => { setShowExportOptions(false); exportCatalogImages(includePrices); }}
            />
          )}
        </header>
      )
    };

    // *** ProductCard com layout de preços atualizado ***
    const ProductCard = ({product, priceMode, showPrices, onSelect})=>{
      return (
        <div onClick={() => onSelect && onSelect(product)} className="bg-white rounded-2xl shadow-md overflow-hidden flex flex-col transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 cursor-pointer">
          <div className="bg-white relative h-64 flex items-center justify-center">
            <img
              loading="lazy"
              src={product.imageUrl || '/img/placeholder.png'}
              alt={product.name}
              className="w-full h-full object-contain"
            />
          </div>
          <div className="p-4 flex-grow flex flex-col">
            <h3 className="font-bold text-lg leading-tight" style={{color:'var(--brand-green)'}}>{product.name}</h3>
            <p className="text-xs text-gray-500 mt-1">Código(s): {product.codes || "-"}</p>
            <p className="text-sm font-semibold mb-3" style={{color:'var(--brand-red)'}}>Sabores: <span className="font-normal text-gray-700">{product.flavors || '-'}</span></p>
            {showPrices && (
              <div className="mt-auto pt-3 border-t space-y-2">
                {(priceMode === 'avista' || priceMode === 'both') && (
                  <>
                    <div className="pl-3 py-1 border-l-4 border-green-500 flex justify-center items-center">
                      <div className="text-center">
                        <span className="block text-xs font-semibold text-gray-700">Unidade à vista</span>
                        <span className="block text-lg font-bold text-gray-900">R$ {Number(product.priceUV || 0).toFixed(2)}</span>
                      </div>
                    </div>
                    <div className="pl-3 py-1 border-l-4 border-green-500 flex justify-center items-center">
                      <div className="text-center">
                        <span className="block text-xs font-semibold text-gray-700">Pacote à vista</span>
                        <span className="block text-lg font-bold text-gray-900">R$ {Number(product.priceFV || 0).toFixed(2)}</span>
                      </div>
                    </div>
                  </>
                )}
                {(priceMode === 'prazo' || priceMode === 'both') && (
                  <>
                    <div className="pl-3 py-1 border-l-4 border-red-500 flex justify-center items-center">
                      <div className="text-center">
                        <span className="block text-xs font-semibold text-gray-700">Unidade a prazo</span>
                        <span className="block text-lg font-bold text-gray-900">R$ {Number(product.priceUP || 0).toFixed(2)}</span>
                      </div>
                    </div>
                    <div className="pl-3 py-1 border-l-4 border-red-500 flex justify-center items-center">
                      <div className="text-center">
                        <span className="block text-xs font-semibold text-gray-700">Pacote a prazo</span>
                        <span className="block text-lg font-bold text-gray-900">R$ {Number(product.priceFP || 0).toFixed(2)}</span>
                      </div>
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      )
    };

    const ProductModal = ({product, onClose, priceMode, showPrices}) => {
      if (!product) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-2xl p-4 max-w-md w-full relative">
            <button onClick={onClose} className="absolute top-2 right-2 text-gray-600 hover:text-gray-800">✕</button>
            <img src={product.imageUrl || '/img/placeholder.png'} alt={product.name} className="w-full h-64 object-contain rounded-xl mb-4" />
            <h2 className="text-2xl font-bold mb-2" style={{color:'var(--brand-green)'}}>{product.name}</h2>
            <p className="text-sm text-gray-600 mb-1">Código(s): {product.codes || '-'}</p>
            <p className="text-sm text-gray-600 mb-4">Sabores: {product.flavors || '-'}</p>
            {showPrices && (
              <div className="space-y-2">
                {(priceMode === 'avista' || priceMode === 'both') && (
                  <>
                    <div className="flex justify-between"><span className="font-semibold">Unidade à vista</span><span>R$ {Number(product.priceUV || 0).toFixed(2)}</span></div>
                    <div className="flex justify-between"><span className="font-semibold">Pacote à vista</span><span>R$ {Number(product.priceFV || 0).toFixed(2)}</span></div>
                  </>
                )}
                {(priceMode === 'prazo' || priceMode === 'both') && (
                  <>
                    <div className="flex justify-between"><span className="font-semibold">Unidade a prazo</span><span>R$ {Number(product.priceUP || 0).toFixed(2)}</span></div>
                    <div className="flex justify-between"><span className="font-semibold">Pacote a prazo</span><span>R$ {Number(product.priceFP || 0).toFixed(2)}</span></div>
                  </>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };

    const HomePage = ()=>{
      const [catalog, setCatalog] = useState({ products:[], settings:{ categoriesOrder:[] } });
      const [loading, setLoading] = useState(true);
      const [query, setQuery] = useState('');
      const [activeCategory, setActiveCategory] = useState(null);
      const [priceMode, setPriceMode] = useState(()=> localStorage.getItem('priceMode') || 'both');
      const [showPrices, setShowPrices] = useState(()=> localStorage.getItem('showPrices') === 'true');
      const [selectedProduct, setSelectedProduct] = useState(null);
      const contentRef = useRef(null);
      const searchRef = useRef(null);

      const loadCatalog = async (searchQuery, category) => {
        setLoading(true);
        try {
          const data = await api.getCatalog({ q: searchQuery, category: category || '' });
          setCatalog(data);
        } catch (error) {
          console.error("Falha ao carregar o catálogo:", error);
          setCatalog({ products: [], settings: { categoriesOrder: [] } });
        } finally {
          setLoading(false);
        }
      }
      
      useEffect(() => {
        loadCatalog('', null);
      }, []);

      useEffect(()=>{ searchRef.current?.focus(); }, []);

      useEffect(()=>{ localStorage.setItem('priceMode', priceMode) }, [priceMode]);
      useEffect(()=>{ localStorage.setItem('showPrices', showPrices) }, [showPrices]);


      const handleSearchSubmit = (e) => {
          e.preventDefault();
          setActiveCategory(null);
          loadCatalog(query, null);
      };
      
      const handleCategoryClick = (category) => {
        setActiveCategory(category);
        setQuery('');
        loadCatalog('', category);
        contentRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      };

      const order = (catalog.settings.categoriesOrder && catalog.settings.categoriesOrder.length)
        ? catalog.settings.categoriesOrder
        : [...new Set((catalog.products || []).map(p => p.category).filter(Boolean))].sort();
      const grouped = (activeCategory? [activeCategory] : order).map(c => ({
        category: c,
        products: catalog.products
          .filter(p => p.category === c)
          .sort((a,b)=> a.name.localeCompare(b.name))
      })).filter(g=>g.products.length>0);

      return (
        <>
        <div className="container mx-auto p-4 sm:p-6 lg:p-8">
          <div className="panel p-6 mb-8 text-center">
            <h1 className="text-4xl font-extrabold text-green-700 mb-2">Seja bem-vindo ao nosso catálogo!</h1>
            <p className="text-gray-700">Explore nossas ofertas e aproveite ótimos preços.</p>
          </div>
          <div className="my-8 text-center">
            <h2 className="text-3xl font-bold mb-2 text-white" style={{textShadow:'1px 1px 3px rgba(0,0,0,0.5)'}}>Certificações</h2>
            <p className="max-w-2xl mx-auto mb-8 text-white" style={{textShadow:'1px 1px 3px rgba(0,0,0,0.4)'}}>Seguimos recomendações rigorosas e controle de qualidade.</p>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              {[
                {src:'https://group-ism.com/br/wp-content/uploads/2023/07/ism-9001.png', title:'ISO 9001', desc:'Gestão da qualidade e melhoria contínua.'},
                {src:'https://group-ism.com/br/wp-content/uploads/2023/07/ism-14001.png', title:'ISO 14001', desc:'Gestão ambiental e proteção do meio ambiente.'},
                {src:'https://group-ism.com/br/wp-content/uploads/2023/07/ism-45001-ES.png', title:'ISO 45001', desc:'Segurança e saúde ocupacional no trabalho.'},
              ].map((it,idx)=>(
                <div key={idx} className="text-white">
                  <div className="iso-round shadow-lg">
                    <img loading="lazy" src={it.src} alt={it.title} onError={(e)=>{e.target.style.display='none'; e.target.parentElement.innerHTML = `<span class='text-xs text-gray-500'>Imagem não<br>disponível</span>`}} />
                  </div>
                  <h3 className="font-bold text-lg">{it.title}</h3>
                  <p className="text-sm opacity-90">{it.desc}</p>
                </div>
              ))}
            </div>
          </div>

          <div className="banner mb-6 rounded-2xl overflow-hidden shadow-lg">
            <img loading="lazy" src="https://i.ibb.co/yFDqWmt0/IMG-0854.jpg" alt="Banner Topo" onError={(e)=>{e.target.src='https://placehold.co/1200x340/0f8a3a/ffffff?text=Banner'}}/>
          </div>

          <div ref={contentRef} className="panel p-6 mb-8">
            <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
              <div className="flex flex-wrap items-center gap-2">
                <button onClick={() => handleCategoryClick(null)} className={`px-4 py-2 text-sm font-semibold rounded-full transition-colors ${!activeCategory? 'bg-green-600 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                  <span className="inline-flex items-center gap-1">{getCategoryIcon('Todas')} Todas</span>
                </button>
                {order.map(cat => (
                  <button key={cat} onClick={() => handleCategoryClick(cat)} className={`px-4 py-2 text-sm font-semibold rounded-full transition-colors ${activeCategory===cat? 'bg-green-600 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                    <span className="inline-flex items-center gap-1">{getCategoryIcon(cat)} {cat}</span>
                  </button>
                ))}
              </div>
              <div className="flex items-center gap-4 flex-wrap">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-semibold text-gray-700">Mostrar preços</span>
                  <div onClick={()=>setShowPrices(v=>!v)} className={`toggle ${showPrices?'active':''}`}><div className="knob"></div></div>
                </div>
                {showPrices && (
                  <select value={priceMode} onChange={e=>setPriceMode(e.target.value)} className="px-4 py-2 text-sm font-semibold rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <option value="both">Preços: ambos</option>
                    <option value="avista">Preços: à vista</option>
                    <option value="prazo">Preços: a prazo</option>
                  </select>
                )}
              </div>
            </div>
            <form onSubmit={handleSearchSubmit} className="relative">
              <input
                ref={searchRef}
                type="text"
                placeholder="Buscar por nome, categoria ou código..."
                value={query}
                onChange={(e) => setQuery(e.target.value)}
                className="w-full pl-4 pr-64 py-3 bg-white border border-gray-300 text-gray-900 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500"
              />
              {query && (
                <button
                  type="button"
                  onClick={()=>{ setQuery(''); loadCatalog('', activeCategory); }}
                  className="absolute top-1/2 right-40 -translate-y-1/2 text-sm text-gray-500 hover:text-gray-700"
                >
                  Limpar
                </button>
              )}
              <button
                type="submit"
                className="absolute top-1/2 right-2 -translate-y-1/2 bg-green-600 text-white font-semibold px-6 py-2 rounded-full hover:bg-green-700 transition-colors"
              >
                Buscar
              </button>
            </form>
          </div>

          {loading ? (
            <div className="py-10 flex flex-col items-center text-white">
              <svg className="animate-spin h-8 w-8 mb-4" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
              </svg>
              <span className="font-bold text-2xl">Carregando...</span>
            </div>
          ) : grouped.length === 0 ? (
            <div className="bg-white rounded-2xl shadow-lg p-8 text-center">
              <p className="text-gray-700 font-semibold">Nenhum produto encontrado. Limpe a busca para ver todos os itens.</p>
            </div>
          ) : (
            <>
              {grouped.map(group=>{
              const hasWaveBg = ['Bebidas não alcoólicas','Bomboneire','Utilidades'].includes(group.category);
              const content = (
                <>
                  {group.category === 'Bebidas alcoólicas' && (
                    <>
                      <div className="mb-6 rounded-2xl overflow-hidden shadow-lg">
                        <img loading="lazy" src="https://i.ibb.co/Vp9Pshb4/IMG-0863.jpg" alt="Novas Cervejas" className="w-full h-auto max-h-340 object-contain"/>
                      </div>
                      <div className="rounded-2xl shadow-lg p-6 mb-6 text-gray-800 bg-[#F7F7F7] border-2 border-black">
                        <h3 className="text-2xl font-bold mb-2 text-green-700">Brussels Pure Malte: a cerveja que se tornou febre nas redes sociais.</h3>
                        <p className="mb-4">Com campanhas estreladas por Ronaldinho Gaúcho, a Brussels chega com reconhecimento imediato do público.</p>
                        <div className="grid md:grid-cols-2 gap-4 mb-4">
                          <div className="bg-white rounded-lg p-4 border-l-4" style={{borderColor:'#1E7E34'}}>
                            <h4 className="text-lg font-bold mb-1" style={{color:'#1E7E34'}}>Lager</h4>
                            <p className="text-sm">Puro malte leve e refrescante.</p>
                          </div>
                          <div className="bg-white rounded-lg p-4 border-l-4" style={{borderColor:'#004085'}}>
                            <h4 className="text-lg font-bold mb-1" style={{color:'#004085'}}>Ultra</h4>
                            <p className="text-sm">Puro malte zero açúcar e zero carboidrato, com o mesmo teor alcoólico e um sabor incrivelmente limpo.</p>
                          </div>
                        </div>
                        <p>Seus rótulos chamam a atenção na geladeira e os formatos (lata 350 ml e garrafa 275 ml) são perfeitos para expor. Com um preço que garante ótima margem, o giro é certo: a curiosidade do seu cliente traz o primeiro pedido, o sabor garante a recompra. Tenha em seu ponto de venda a novidade que todos já estão procurando!</p>
                      </div>
                    </>
                  )}
                  {group.category === 'Bebidas não alcoólicas' && (
                    <div className="mb-8 panel p-6 overflow-hidden text-gray-800">
                      <div className="ism-section flex flex-col gap-4 sm:flex-row sm:gap-0">
                        <div className="ism-image w-full">
                          <img loading="lazy" src="https://i.ibb.co/MkBdYQ1Z/484319138-122166789608286629-3240958178884466690-n.jpg" alt="ISM Brasil" className="w-full h-full object-cover"/>
                          <img loading="lazy" src="https://i.ibb.co/PvnmNKKw/100.jpg" alt="ISM Brasil produtos" className="w-full h-full object-cover"/>
                        </div>
                        <div className="ism-text w-full sm:pl-6">
                          <h3 className="text-xl font-bold text-green-700 mb-1">ISM Brasil: portfólio de alto giro para o seu negócio.</h3>
                          <p className="text-xs leading-tight">Multinacional presente em 7 países, com fábrica em Alagoinhas–BA — cidade reconhecida pela pureza da sua água —, a ISM entrega um mix que vende o dia todo:</p>
                          <div className="mt-2 grid grid-cols-2 gap-2 text-[9px] leading-snug">
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">Goob</h4>
                              <p>Refrescância e sabor. Goob se consolidou no mercado baiano. Segundo o Instituto Baiano de Pesquisa e Consumo, Goob registrou um crescimento de 39% em vendas em 2025, figurando entre os 10 refrigerantes mais consumidos na região.</p>
                            </div>
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">Lôa</h4>
                              <p>Pureza que se sente a cada gole. Originária de Alagoinhas — reconhecida por ter a 2ª melhor água do mundo —, Lôa é a líder absoluta em sua categoria. Sua qualidade superior a torna um produto de giro rápido e garantido.</p>
                            </div>
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">EnerUp</h4>
                              <p>A combinação perfeita de taurina, cafeína, guaraná e vitaminas. EnerUp já se tornou um fenômeno de consumo, especialmente em combinação com destilados.</p>
                            </div>
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">DrinkT</h4>
                              <p>Sabor, praticidade e refrescância. Ideal para o clima da nossa terra, o DrinkT apresenta um aumento de 27% no volume de vendas durante os dias mais quentes, sendo a escolha inteligente para se refrescar com qualidade e sabor.</p>
                            </div>
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">Yulo</h4>
                              <p>O suco que conquistou as famílias. Yulo se destaca pela altíssima taxa de fidelidade. Dados da Central de Análise de Varejo da Bahia mostram que 6 em cada 10 famílias que experimentam realizam a recompra em menos de 30 dias.</p>
                            </div>
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">GuaranUp</h4>
                              <p>A dose ideal de energia para a rotina. Posicionado próximo a balcões de salgados/lanches, GuaranUp demonstra um aumento de 19% no giro de estoque, provando ser o acompanhamento perfeito para uma refeição rápida e energizante.</p>
                            </div>
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">Glow Ice</h4>
                              <p>Leveza e autenticidade. Com um sabor único, Glow Ice atrai pela curiosidade e conquista pelo paladar. Estatísticas de pontos de venda indicam que 1 em cada 3 clientes experimenta o produto logo na primeira semana de exposição.</p>
                            </div>
                            <div className="space-y-1">
                              <h4 className="font-bold text-[11px]">Gostolac</h4>
                              <p>Sabor e economia. Desenvolvido para oferecer um sabor delicioso e um rendimento superior, Gostolac se destaca na categoria. Ele oferece um rendimento 15% maior por litro em comparação com a média dos concorrentes.</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  <h2 className="flex items-center gap-2 text-3xl font-bold text-white mb-4" style={{textShadow:'1px 1px 3px rgba(0,0,0,0.5)'}}>{getCategoryIcon(group.category)}{group.category}</h2>
                  <div className="bg-white rounded-2xl shadow-lg p-4 sm:p-6">
                    <div className={`grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6`}>
                      {group.products.map(p=><ProductCard key={p.id} product={p} priceMode={priceMode} showPrices={showPrices} onSelect={setSelectedProduct}/>)}
                    </div>
                  </div>
                </>
              );
              return (
                <div key={group.category} className="mb-12">
                  {hasWaveBg? (
                    <div className="category-wave-wrapper"><div className="category-content">{content}</div></div>
                  ) : content}
                </div>
              )
            })}
              <footer className="mt-8 w-full bg-red-700 text-white py-12 flex flex-col items-center justify-center text-center">
                <span className="text-5xl mb-4">🤝</span>
                <p className="text-2xl font-bold">Você chegou ao final do catálogo!</p>
                <p className="text-base mt-3 max-w-xl px-4">Foi um prazer ter você aqui. Agradecemos de coração pela visita e estamos sempre prontos para atender suas necessidades. Volte sempre!</p>
              </footer>
            </>
          )}
        </div>
        <ProductModal product={selectedProduct} onClose={()=>setSelectedProduct(null)} priceMode={priceMode} showPrices={showPrices} />
        </>
      )
    };

    const AdminLoginPage = ()=>{
      const { navigate, auth } = useApp();
      const [password,setPassword] = useState('');
      const [loading,setLoading]=useState(false);
      const [error,setError]=useState('');
      const submit = async (e)=>{
        e.preventDefault(); setLoading(true); setError('');
        const r = await auth.login(password);
        if (r.ok) navigate('admin/products'); else { setError('Senha incorreta.'); setLoading(false); }
      };
      return (
        <div className="flex justify-center items-center pt-20">
          <form onSubmit={submit} className="panel p-8 w-full max-w-sm">
            <h1 className="text-2xl font-bold text-center mb-6 text-gray-800">Bem-vindo de volta!</h1>
            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Digite a senha admin" className="w-full px-4 py-3 bg-white border-2 border-gray-300 text-gray-900 rounded-xl mb-4 focus:outline-none focus:border-green-500"/>
            <button className="w-full bg-green-600 text-white font-bold py-3 rounded-xl hover:bg-green-700 disabled:bg-gray-400 transition-colors" disabled={loading}>{loading?'Entrando...':'Entrar'}</button>
            {error && <p className="text-red-500 text-center mt-4">{error}</p>}
          </form>
        </div>
      )
    };

    const AdminProductListPage = ()=>{
      const { navigate } = useApp();
      const [products,setProducts]=useState([]);
      const [loading,setLoading]=useState(true);
      const [search,setSearch]=useState('');
      const ref = useRef(null);

      const load = async ()=>{
        setLoading(true); const data = await api.getAdminProducts(); setProducts(data); setLoading(false);
      }
      useEffect(()=>{ load() },[]);
      useEffect(()=>{
        if (ref.current && !loading && window.innerWidth >= 768){ // Sortable only on desktop
          new Sortable(ref.current, {
            animation:150,
            handle: '.handle',
            onEnd: async (evt)=>{
              const arr = [...products];
              const [moved] = arr.splice(evt.oldIndex,1);
              arr.splice(evt.newIndex,0,moved);
              setProducts(arr);
              await api.reorderProducts(arr.map(p=>p.id));
            }
          })
        }
      },[loading,products]);

      const remove = async (id)=>{
        if (!confirm('Excluir este produto?')) return;
        await api.deleteProduct(id);
        await load();
      }

      const filtered = products.filter(p => {
        const term = search.toLowerCase();
        return p.name.toLowerCase().includes(term) || (p.codes || '').toLowerCase().includes(term);
      });

      return (
        <div className="container mx-auto p-4 sm:p-6 lg:p-8">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <h1 className="text-3xl font-bold text-white" style={{textShadow:'1px 1px 3px rgba(0,0,0,0.5)'}}>Produtos</h1>
            <div className="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
              <input
                type="text"
                value={search}
                onChange={e=>setSearch(e.target.value)}
                placeholder="Buscar por nome ou código..."
                className="w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
              />
              <button onClick={()=>navigate('admin/product/new')} className="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">Adicionar</button>
            </div>
          </div>
          
          {/* Layout de Tabela para Telas Médias e Maiores */}
          <div className="panel p-4 hidden md:block">
            <table className="w-full">
              <thead><tr className="border-b-2 border-gray-200">
                <th className="p-3 text-left text-sm font-semibold text-gray-500 w-12"></th>
                <th className="p-3 text-left text-sm font-semibold text-gray-500">Produto</th>
                <th className="p-3 text-left text-sm font-semibold text-gray-500">Categoria</th>
                <th className="p-3 text-left text-sm font-semibold text-gray-500">Ativo</th>
                <th className="p-3 text-right text-sm font-semibold text-gray-500">Ações</th>
              </tr></thead>
              <tbody ref={ref}>
                {loading? (<tr><td colSpan="5" className="p-4 text-center">Carregando...</td></tr>):
                  filtered.map((p)=>(
                  <tr key={p.id} className="border-b border-gray-200 last:border-b-0">
                    <td className="p-3 text-center handle text-gray-400 cursor-move">☰</td>
                    <td className="p-3 font-semibold text-gray-800">
                      <div className="flex items-center gap-3">
                        <img src={p.imageUrl||'/img/placeholder.png'} className="w-12 h-12 object-contain rounded bg-gray-100 p-1"/>
                        <div>{p.name}<div className="text-xs text-gray-500 font-normal">Códigos: {p.codes || '-'}</div></div>
                      </div>
                    </td>
                    <td className="p-3 text-gray-600">{p.category}</td>
                    <td className="p-3 text-gray-600">{p.active?'Sim':'Não'}</td>
                    <td className="p-3 whitespace-nowrap text-right">
                      <div className="flex gap-2 justify-end">
                        <button onClick={() => navigate('admin/product/edit', { id: p.id })} className="bg-blue-500 text-white p-2 rounded-md text-sm font-semibold hover:bg-blue-600 transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>
                        </button>
                        <button onClick={() => remove(p.id)} className="bg-red-500 text-white p-2 rounded-md text-sm font-semibold hover:bg-red-600 transition-colors">
                           <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Layout de Cards para Telas Pequenas */}
          <div className="md:hidden space-y-4">
            {loading ? <div className="text-center text-white">Carregando...</div> :
              filtered.map(p => (
                <div key={p.id} className="panel p-4 flex gap-4 items-center">
                  <img src={p.imageUrl||'/img/placeholder.png'} className="w-16 h-16 object-contain rounded bg-gray-100 p-1"/>
                  <div className="flex-grow">
                    <h3 className="font-bold text-gray-800">{p.name}</h3>
                    <p className="text-sm text-gray-500">{p.category}</p>
                    <p className="text-xs text-gray-500">Ativo: {p.active ? 'Sim' : 'Não'}</p>
                  </div>
                  <div className="flex flex-col gap-2">
                    <button onClick={() => navigate('admin/product/edit', { id: p.id })} className="bg-blue-500 text-white p-2 rounded-md text-sm font-semibold hover:bg-blue-600 transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>
                    </button>
                    <button onClick={() => remove(p.id)} className="bg-red-500 text-white p-2 rounded-md text-sm font-semibold hover:bg-red-600 transition-colors">
                       <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
                    </button>
                  </div>
                </div>
              ))
            }
          </div>

        </div>
      )
    };

    const AdminProductEditPage = ()=>{
      const { navigate, route } = useApp();
      let id = route.params?.id;
      if (typeof id === 'undefined' || id === null) {
        const sp = new URLSearchParams(location.search);
        const qsId = sp.get('id');
        if (qsId) id = qsId;
      }
      const [product,setProduct]=useState(null);
      const [loading,setLoading]=useState(true);
      const [imagePreview,setImagePreview]=useState(null);
      const fileRef = useRef(null);
      const [categories,setCategories]=useState([]);
      const [flavors,setFlavors]=useState(['']);

      useEffect(() => {
        (async () => {
          try {
            const s = await (await fetch('/api/settings')).json();
            const cats = s.categoriesOrder || [];
            setCategories(cats);
            if (id) {
              try {
                const p = await api.getProduct(id);
                if (p && !p.error) {
                  setProduct(p);
                  if (p.imageUrl) setImagePreview(p.imageUrl);
                  const fl = p.flavors ? p.flavors.split(',').map(f=>f.trim()) : [''];
                  setFlavors(fl);
                } else {
                  setProduct({ name: '', category: cats[0] || '', active: true });
                  setFlavors(['']);
                }
              } catch (err) {
                setProduct({ name: '', category: cats[0] || '', active: true });
              }
            } else {
              setProduct({ name: '', category: cats[0] || '', active: true });
              setFlavors(['']);
            }
          } catch (err) {
            console.error(err);
            setProduct({ name: '', category: '', active: true });
            setFlavors(['']);
          }
          setLoading(false);
        })();
      }, [id]);

      const change = (e)=>{
        const { name, value, type, checked } = e.target;
        setProduct(p=>({...p, [name]: (type==='checkbox'? checked : value)}));
      }
      const changeFlavor = (idx,val)=>{
        setFlavors(f=>f.map((s,i)=> i===idx? val : s));
      }
      const onImage = (e)=>{
        if (e.target.files && e.target.files[0]){
          const file = e.target.files[0];
          setImagePreview(URL.createObjectURL(file));
        }
      }
      const save = async ()=>{
        const fd = new FormData();
        Object.entries(product).forEach(([k,v])=>{
          if (k==='flavors') return;
          if (['priceUV','priceUP','priceFV','priceFP'].includes(k) && (v===undefined||v===null||v==='')) return;
          fd.append(k, v);
        });
        const flStr = flavors.map(f=>f.trim()).filter(Boolean).join(', ');
        if (flStr) fd.append('flavors', flStr);
        if (fileRef.current?.files?.[0]) fd.append('image', fileRef.current.files[0]);
        if (id) await api.updateProduct(id, fd); else await api.createProduct(fd);
        navigate('admin/products');
      }

      if (loading) return <div className="text-center text-white text-2xl font-bold pt-20">Carregando...</div>;
      if (!product) return <div className="text-center text-red-500 text-2xl font-bold pt-20">Produto não encontrado.</div>;

      return (
        <div className="container mx-auto p-4 sm:p-6 lg:p-8">
          <h1 className="text-3xl font-bold text-white mb-6" style={{textShadow:'1px 1px 3px rgba(0,0,0,0.5)'}}>{id? 'Editar Produto':'Adicionar Produto'}</h1>
          <div className="panel p-8 text-gray-800">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="md:col-span-2 space-y-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                  <div><label className="block font-semibold mb-1">Nome</label><input name="name" value={product.name} onChange={change} className="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg"/></div>
                  <div><label className="block font-semibold mb-1">Categoria</label>
                    <select name="category" value={product.category} onChange={change} className="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg">
                      {categories.map(c=> <option key={c} value={c}>{c}</option>)}
                    </select>
                  </div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                  <div><label className="block font-semibold mb-1">Códigos</label><input name="codes" value={product.codes||''} onChange={change} className="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg"/></div>
                  <div>
                    <label className="block font-semibold mb-1">Sabores/Disponibilidade</label>
                    {flavors.map((fl,idx)=>(
                      <div key={idx} className="mb-2 relative">
                        <input value={fl} onChange={e=>changeFlavor(idx,e.target.value)} className="w-full p-2 pr-8 bg-gray-100 border border-gray-300 rounded-lg"/>
                        {flavors.length>1 && <button type="button" onClick={()=>setFlavors(f=>f.filter((_,i)=>i!==idx))} className="absolute top-1/2 -translate-y-1/2 right-2 text-red-500">✕</button>}
                      </div>
                    ))}
                    <button type="button" onClick={()=>setFlavors(f=>[...f,''])} className="bg-green-600 text-white px-3 py-1 rounded-full text-sm">+ sabor</button>
                  </div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div><label className="block font-semibold mb-1">Preço Unidade (à vista)</label><input name="priceUV" type="text" value={product.priceUV??''} onChange={change} className="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg"/></div>
                    <div><label className="block font-semibold mb-1">Preço Unidade (a prazo)</label><input name="priceUP" type="text" value={product.priceUP??''} onChange={change} className="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg"/></div>
                  </div>
                  <div className="space-y-4">
                    <div><label className="block font-semibold mb-1">Preço Pacote (à vista)</label><input name="priceFV" type="text" value={product.priceFV??''} onChange={change} className="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg"/></div>
                    <div><label className="block font-semibold mb-1">Preço Pacote (a prazo)</label><input name="priceFP" type="text" value={product.priceFP??''} onChange={change} className="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg"/></div>
                  </div>
                </div>
              </div>
              <div className="space-y-2">
                <label className="block font-semibold mb-1">Imagem do Produto</label>
                <div className="w-full h-52 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed">
                  {imagePreview? <img src={imagePreview} className="h-full w-full object-contain rounded-lg"/> : <span className="text-gray-500">Pré-visualização</span>}
                </div>
                <input ref={fileRef} type="file" accept="image/*" onChange={onImage} className="hidden"/>
                <button onClick={()=>fileRef.current.click()} className="w-full bg-gray-200 text-gray-800 font-semibold py-2 rounded-lg hover:bg-gray-300">Adicionar Imagem</button>
              </div>
            </div>
            <div className="mt-6 flex items-center justify-between">
              <label className="flex items-center gap-2"><input type="checkbox" name="active" checked={!!product.active} onChange={(e)=>setProduct(p=>({...p, active:e.target.checked}))}/> Ativo</label>
              <div className="flex gap-2">
                <button onClick={()=>navigate('admin/products')} className="bg-gray-200 text-gray-800 font-semibold px-6 py-2 rounded-lg">Cancelar</button>
                <button onClick={save} className="bg-green-600 text-white font-semibold px-6 py-2 rounded-lg">Salvar</button>
              </div>
            </div>
          </div>
        </div>
      )
    };

    const App = ()=>{
      const { route, auth } = useApp();
      if (!auth.isAdmin && route.name.startsWith('admin')) return <AdminLoginPage/>;
      switch(route.name){
        case 'home': return <HomePage/>;
        case 'admin': return <AdminLoginPage/>;
        case 'admin/products': return <AdminProductListPage/>;
        case 'admin/product/edit': return <AdminProductEditPage/>;
        case 'admin/product/new': return <AdminProductEditPage/>;
        default: return <HomePage/>;
      }
    };

    ReactDOM.render(<AppProvider><Header/><main><App/></main></AppProvider>, document.getElementById('root'));

    if ('serviceWorker' in navigator){
      window.addEventListener('load', async ()=>{
        try{
          const regs = await navigator.serviceWorker.getRegistrations();
          regs.forEach(r=>{
            if (!r.active || (r.active && !r.active.scriptURL.endsWith('/sw.js'))) r.unregister();
          });
          await navigator.serviceWorker.register('/sw.js');
        }catch(e){ console.warn('SW',e) }
      })
    }
  </script>
</body>
</html>